<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>

  <link rel="stylesheet" href="dashboard.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h1 class="brand">ArshaApparel</h1>

    <nav>
      <a href="index.html">Home</a>
      <a class="active">Dashboard</a>
      <a href="product.html">Products</a>
      <a href="orders.html">Orders</a>
      <a href="payments.html">Payments</a>
      <a href="login.html" class="logout" id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- TOP BAR -->
    <header class="topbar">
      <div>
        <h2>Dashboard</h2>
        <p class="welcome" id="welcomeText">Welcome back.</p>
      </div>

      <div class="user-meta">
        <span class="role-pill role-user" id="rolePill">user</span>
        <div class="top-actions">
          <a class="icon" href="reset.html" aria-label="Reset Data">&#9881;</a>
          <button class="icon" aria-label="Profile" id="userBadge">&#128100;</button>
          <button class="menu-toggle" id="menuToggle" type="button" aria-label="Open menu">☰</button>
        </div>
      </div>
    </header>

    <!-- STATS -->
    <section class="stats">
      <div class="card">
        <p>Total Products</p>
        <h3 id="statTotal">0</h3>
      </div>
      <div class="card">
        <p>Active Products</p>
        <h3 id="statActive">0</h3>
      </div>
      <div class="card">
        <p>Out of Stock</p>
        <h3 id="statOut">0</h3>
      </div>
    </section>

    <!-- TABLE -->
    <section class="table-card">
      <h3>Latest Products</h3>
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Category</th>
            <th>Status</th>
            <th>Stock</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody id="dashboardProductsBody">
          <tr>
            <td colspan="5">Loading products...</td>
          </tr>
        </tbody>
      </table>
    </section>

  </main>
</div>
<div class="nav-overlay" id="navOverlay"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>
<script src="supabase-init.js"></script>
<script>
  const stored = localStorage.getItem('loginInfo') || sessionStorage.getItem('loginInfo');
  const welcomeText = document.getElementById('welcomeText');
  const rolePill = document.getElementById('rolePill');
  const userBadge = document.getElementById('userBadge');
  const logoutBtn = document.getElementById('logoutBtn');
  const statTotal = document.getElementById('statTotal');
  const statActive = document.getElementById('statActive');
  const statOut = document.getElementById('statOut');
  const dashboardProductsBody = document.getElementById('dashboardProductsBody');
  const supabaseClient = window.supabaseClient;

  if (stored) {
    try {
      const data = JSON.parse(stored);
      const name = data.name || (data.email ? data.email.split('@')[0] : 'User');
      const role = data.role || 'user';

      welcomeText.textContent = `Welcome back, ${name}.`;
      rolePill.textContent = role;
      rolePill.classList.toggle('role-admin', role === 'admin');
      rolePill.classList.toggle('role-user', role !== 'admin');
      userBadge.textContent = role === 'admin' ? 'A' : 'U';
    } catch (error) {
      welcomeText.textContent = 'Welcome back.';
    }
  }

  logoutBtn.addEventListener('click', (event) => {
    event.preventDefault();
    localStorage.removeItem('loginInfo');
    sessionStorage.removeItem('loginInfo');
    window.location.href = 'login.html';
  });

  const idrFormatter = new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  });

  function formatPrice(value) {
    const number = Number(value);
    if (Number.isNaN(number)) return value || '-';
    return idrFormatter.format(number);
  }

  function statusClass(status) {
    const value = (status || '').toLowerCase();
    if (value === 'active') return 'success';
    if (value === 'out') return 'warning';
    if (value === 'draft') return 'info';
    return 'info';
  }

  function renderDashboard(products) {
    if (!dashboardProductsBody) return;
    if (!products || products.length === 0) {
      dashboardProductsBody.innerHTML = `
        <tr>
          <td colspan="5">No products found.</td>
        </tr>
      `;
      statTotal.textContent = '0';
      statActive.textContent = '0';
      statOut.textContent = '0';
      return;
    }

    const total = products.length;
    const active = products.filter(item => (item.status || '').toLowerCase() === 'active').length;
    const out = products.filter(item => Number(item.stock) === 0 || (item.status || '').toLowerCase() === 'out').length;

    statTotal.textContent = total;
    statActive.textContent = active;
    statOut.textContent = out;

    const latest = products.slice(0, 5);
    dashboardProductsBody.innerHTML = latest.map(product => `
      <tr>
        <td>${product.name}</td>
        <td>${product.category || '-'}</td>
        <td><span class="badge ${statusClass(product.status)}">${product.status || '-'}</span></td>
        <td>${product.stock ?? '-'}</td>
        <td>${formatPrice(product.price)}</td>
      </tr>
    `).join('');
  }

  async function fetchDashboardProducts() {
    if (!supabaseClient) return;
    const { data, error } = await supabaseClient
      .from('products')
      .select('id, name, price, category, status, stock')
      .order('created_at', { ascending: false });

    if (error) {
      console.warn('Failed to load products', error.message);
      return;
    }

    renderDashboard(data);
  }

  if (supabaseClient) {
    fetchDashboardProducts();
    supabaseClient
      .channel('public:products')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, fetchDashboardProducts)
      .subscribe();
  }

  const menuToggle = document.getElementById('menuToggle');
  const navOverlay = document.getElementById('navOverlay');

  function setNavOpen(open) {
    document.body.classList.toggle('nav-open', open);
  }

  if (menuToggle) {
    menuToggle.addEventListener('click', () => {
      setNavOpen(!document.body.classList.contains('nav-open'));
    });
  }

  if (navOverlay) {
    navOverlay.addEventListener('click', () => setNavOpen(false));
  }

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') setNavOpen(false);
  });

  window.addEventListener('resize', () => {
    if (window.innerWidth > 900) setNavOpen(false);
  });
</script>

</body>
</html>
